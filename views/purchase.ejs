<!DOCTYPE html>
<html>

<head>
    <title>Purchase Goods</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #0f5132, #198754);
            min-height: 100vh;
        }

        .card {
            border-radius: 18px;
        }
    </style>
</head>

<body>

    <div class="container mt-4">
        <a href="/" class="btn btn-outline-light mb-3">
            ← Back to Users
        </a>
    </div>
    <div class="container my-5">

        <h3 class="text-center text-light mb-4">Purchase Goods</h3>

        <!-- DETAILS -->
        <div class="card p-4 bg-light mb-4">
            <strong>Name:</strong>
            <%= ration.name %><br>
                <strong>Ration No:</strong>
                <%= ration.rationNo %><br>
                    <strong>Category:</strong>
                    <%= ration.category %>
        </div>

        <!-- GOODS -->
        <div class="card p-4 bg-light">

            <table class="table table-bordered text-center">
                <thead class="table-success">
                    <tr>
                        <th>Item</th>
                        <th>Max</th>
                        <th>Price (₹)</th>
                        <th>Qty</th>
                    </tr>
                </thead>
                <tbody>

                    <% if (ration.category==='BPL' ) { %>
                        <tr>
                            <td>Rice</td>
                            <td>18 Kg</td>
                            <td>3</td>
                            <td><input class="form-control qty" data-max="18" data-price="3"></td>
                        </tr>
                        <tr>
                            <td>Wheat</td>
                            <td>5 Kg</td>
                            <td>4</td>
                            <td><input class="form-control qty" data-max="5" data-price="4"></td>
                        </tr>
                        <tr>
                            <td>Sugar</td>
                            <td>4 Kg</td>
                            <td>5</td>
                            <td><input class="form-control qty" data-max="4" data-price="5"></td>
                        </tr>
                        <tr>
                            <td>Kerosene</td>
                            <td>2 L</td>
                            <td>8</td>
                            <td><input class="form-control qty" data-max="2" data-price="8"></td>
                        </tr>
                        <tr>
                            <td>Pulses</td>
                            <td>1 Kg</td>
                            <td>10</td>
                            <td><input class="form-control qty" data-max="1" data-price="10"></td>
                        </tr>
                        <% } else { %>
                            <tr>
                                <td>Rice</td>
                                <td>11 Kg</td>
                                <td>5</td>
                                <td><input class="form-control qty" data-max="11" data-price="5"></td>
                            </tr>
                            <tr>
                                <td>Wheat</td>
                                <td>2 Kg</td>
                                <td>6</td>
                                <td><input class="form-control qty" data-max="2" data-price="6"></td>
                            </tr>
                            <tr>
                                <td>Sugar</td>
                                <td>2 Kg</td>
                                <td>7</td>
                                <td><input class="form-control qty" data-max="2" data-price="7"></td>
                            </tr>
                            <tr>
                                <td>Kerosene</td>
                                <td>1 L</td>
                                <td>10</td>
                                <td><input class="form-control qty" data-max="1" data-price="10"></td>
                            </tr>
                            <% } %>

                </tbody>
            </table>

            <h5 class="text-end">Total ₹ <span id="total">0</span></h5>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary w-50" onclick="calculateSum()">
                    Sum
                </button>

                <button class="btn btn-success w-50" onclick="proceedDeal()">
                    Proceed
                </button>
            </div>

            <p id="msg" class="fw-bold text-center mt-3"></p>

        </div>

    </div>

</body>

<script>
    function calculateSum() {
        let total = 0;
        let valid = true;

        document.querySelectorAll('.qty').forEach(q => {
            const qty = Number(q.value || 0);
            const max = Number(q.dataset.max);
            const price = Number(q.dataset.price);

            if (qty > max) {
                q.classList.add('border-danger');
                valid = false;
            } else {
                q.classList.remove('border-danger');
            }

            total += qty * price;
        });

        if (!valid) {
            document.getElementById('msg').innerText =
                "❌ Quantity exceeds allowed limit";
            document.getElementById('msg').className = "text-danger fw-bold";
            return;
        }

        document.getElementById('total').innerText = total;
        document.getElementById('msg').innerText =
            "ℹ️ Review total before proceeding";
        document.getElementById('msg').className = "text-warning fw-bold";
    }

    function proceedDeal() {
        let total = 0;
        let valid = true;

        document.querySelectorAll('.qty').forEach(q => {
            const qty = Number(q.value || 0);
            const max = Number(q.dataset.max);
            const price = Number(q.dataset.price);

            if (qty > max) {
                q.classList.add('border-danger');
                valid = false;
            } else {
                q.classList.remove('border-danger');
            }

            calculateSum();
        });

        if (!valid) {
            document.getElementById('msg').innerText =
                "❌ Quantity exceeds allowed limit";
            document.getElementById('msg').className = "text-danger fw-bold";
            return;
        }

        document.getElementById('total').innerText = total;
        document.getElementById('msg').innerText =
            "✅ Deal completed successfully";
        document.getElementById('msg').className = "text-success fw-bold";

        setTimeout(() => {
            window.location.href = "/";
        }, 1500);
    }
</script>

</html>